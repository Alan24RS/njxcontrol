name: NicoBot

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-branch:
    name: Branch naming
    runs-on: ubuntu-latest
    steps:
      - name: Verificar que el nombre de la rama siga las convenciones (feature/, fix/, etc.)
        run: |
          BRANCH_NAME="${{ github.head_ref }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Validando nombre de rama: $BRANCH_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Validar formato de nombre de rama
          if [[ ! $BRANCH_NAME =~ ^(feature|fix|hotfix|release|backport|docs|refactor|test|ci|chore)/.+ ]]; then
            echo "âŒ ERROR: El nombre de la rama NO sigue las convenciones del proyecto"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ FORMATO REQUERIDO: <tipo>/<descripciÃ³n>                        â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "Tipos vÃ¡lidos y sus usos:"
            echo "  - feature/    â†’ Nueva funcionalidad"
            echo "  - fix/        â†’ CorrecciÃ³n de bugs"
            echo "  - hotfix/     â†’ Fix crÃ­tico en producciÃ³n"
            echo "  - release/    â†’ PreparaciÃ³n de release"
            echo "  - backport/   â†’ Backport de cambios"
            echo "  - docs/       â†’ Solo cambios de documentaciÃ³n"
            echo "  - refactor/   â†’ RefactorizaciÃ³n de cÃ³digo"
            echo "  - test/       â†’ AdiciÃ³n de tests"
            echo "  - ci/         â†’ Cambios en CI/CD"
            echo "  - chore/      â†’ Tareas de mantenimiento"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ EJEMPLO: feature/agregar-autenticacion-usuarios                â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "CÃ³mo renombrar tu rama:"
            echo "   git branch -m <tipo>/$BRANCH_NAME"
            echo "   git push origin -d $BRANCH_NAME"
            echo "   git push origin <tipo>/$BRANCH_NAME"
            echo ""
            echo "Ver: CONTRIBUTING.md para mÃ¡s informaciÃ³n"
            echo ""
            exit 1
          fi

          echo "ValidaciÃ³n exitosa: $BRANCH_NAME"
          echo ""

  code-quality:
    name: Code quality
    runs-on: ubuntu-latest
    needs: [validate-branch]
    steps:
      - name: Descargar cÃ³digo del repositorio
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Configurar pnpm
        uses: pnpm/action-setup@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Instalar dependencias
        run: pnpm install --frozen-lockfile

      - name: Verificar reglas de ESLint (linting)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Ejecutando ESLint..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          pnpm lint
          echo ""
          echo "No se encontraron problemas de linting"
          echo ""
          echo "Si falla: Ejecuta 'pnpm lint' localmente para ver los errores"
          echo ""

      - name: Verificar formato de cÃ³digo (Prettier)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Verificando formato con Prettier..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          pnpm format:check
          echo ""
          echo "El cÃ³digo estÃ¡ correctamente formateado"
          echo ""
          echo "Si falla: Ejecuta 'pnpm format' para arreglar el formato automÃ¡ticamente"
          echo ""

      - name: Verificar tipos de TypeScript
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Verificando tipos de TypeScript..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          pnpm typecheck
          echo ""
          echo "No se encontraron errores de tipos"
          echo ""
          echo "Si falla: Ejecuta 'pnpm typecheck' localmente para ver los errores de tipos"
          echo ""

  preview-deploy:
    name: Preview deploy
    runs-on: ubuntu-latest
    needs: [validate-branch, code-quality]
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ğŸ”§ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ğŸ” Detect database changes
        id: detect-changes
        run: |
          echo "ğŸ” Analyzing PR for database changes..."

          # Get the base commit (target branch)
          BASE_COMMIT="${{ github.event.pull_request.base.sha }}"
          HEAD_COMMIT="${{ github.event.pull_request.head.sha }}"

          echo "Base commit: $BASE_COMMIT"
          echo "Head commit: $HEAD_COMMIT"

          # Check for new migration files
          MIGRATION_FILES=$(git diff --name-only $BASE_COMMIT..$HEAD_COMMIT | grep "supabase/migrations/.*\.sql$" || echo "")

          if [ -n "$MIGRATION_FILES" ]; then
            echo "ğŸ“‹ Found new migrations:"
            echo "$MIGRATION_FILES"
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "migration_files<<EOF" >> $GITHUB_OUTPUT
            echo "$MIGRATION_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âœ… No new migrations found"
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ—„ï¸ Note about database migrations
        if: steps.detect-changes.outputs.has_migrations == 'true'
        id: handle-migrations
        run: |
          echo "ğŸ“‹ Database migrations detected in this PR"
          echo "â„¹ï¸ Preview will use the current staging database state"
          echo "âš ï¸ Migrations will be applied when merging to main"
          echo ""
          echo "Migration files found:"
          echo "${{ steps.detect-changes.outputs.migration_files }}"
          echo ""
          echo "migration_status=detected" >> $GITHUB_OUTPUT

      - name: â¬‡ï¸ Pull Vercel environment information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ—ï¸ Build project artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸš€ Deploy preview to Vercel
        id: deploy
        run: |
          # Configure Git to use your identity
          git config user.name "Nico Segurado"
          git config user.email "nicosegurado735@gmail.com"

          # Create a temporary commit with your identity for Vercel
          git commit --allow-empty -m "temp: deployment commit" --author="Nico Segurado <nicosegurado735@gmail.com>"

          # Deploy with your identity
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ğŸš€ Preview deployed to: $DEPLOYMENT_URL"

          # Clean up the temporary commit
          git reset --hard HEAD~1

      - name: ğŸ’¬ Comment deployment URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸš€ Preview Deployment')
            );

            const hasMigrations = '${{ steps.detect-changes.outputs.has_migrations }}' === 'true';

            let statusIcon = 'âœ…';
            let statusText = 'Deployed successfully';
            let migrationInfo = '';

            if (hasMigrations) {
              statusIcon = 'âš ï¸';
              statusText = 'Deployed (with pending migrations)';
              migrationInfo = '**Database:** ğŸ—„ï¸ Using current staging database. Migrations will be applied on merge.';
            } else {
              migrationInfo = '**Database:** âœ… No migrations detected';
            }

            const commentBody = `## ${statusIcon} Preview Deployment
              
              **Status:** ${statusText}
              
              **Preview URL:** [${{ steps.deploy.outputs.deployment_url }}](${{ steps.deploy.outputs.deployment_url }})
              
              ${migrationInfo}
              
              ${hasMigrations ? `
              **âš ï¸ Pending Migration Files:**
              \`\`\`
              ${{ steps.detect-changes.outputs.migration_files }}
              \`\`\`
              
              > **Note:** This preview uses the current staging database. Database migrations will be automatically applied when this PR is merged to main.
              ` : ''}
              
              ---
              
              The preview will be automatically updated when you push new commits to this PR.`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }
