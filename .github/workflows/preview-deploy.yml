name: NJX-Bot

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [develop, main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-branch:
    name: Branch naming
    runs-on: ubuntu-latest
    steps:
      - name: Verificar nombre de rama
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          echo "Validando: $BRANCH_NAME ‚Üí $TARGET_BRANCH"
          if [[ ! $BRANCH_NAME =~ ^(feature|fix|hotfix|release|backport|docs|refactor|test|ci|chore)/.+ ]]; then
            echo "‚ùå ERROR: El nombre de la rama NO sigue las convenciones del proyecto"
            exit 1
          fi
          BRANCH_TYPE=$(echo $BRANCH_NAME | cut -d'/' -f1)
          if [[ "$TARGET_BRANCH" == "main" ]]; then
            if [[ ! "$BRANCH_TYPE" =~ ^(hotfix|release|backport)$ ]]; then
              echo "‚ùå ERROR: Solo 'hotfix/*', 'release/*' o 'backport/*' pueden ir a 'main'"
              exit 1
            fi
          fi
          echo "Validaci√≥n exitosa: $BRANCH_NAME ‚Üí $TARGET_BRANCH"

  code-quality:
    name: Code quality
    runs-on: ubuntu-latest
    needs: [validate-branch]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: ESLint
        run: pnpm lint
      - name: Prettier
        run: pnpm format:check
      - name: TypeScript
        run: pnpm typecheck

  preview-deploy:
    name: Preview deploy
    runs-on: ubuntu-latest
    needs: [validate-branch, code-quality]
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Detect database changes
        id: detect-changes
        run: |
          BASE_COMMIT="${{ github.event.pull_request.base.sha }}"
          HEAD_COMMIT="${{ github.event.pull_request.head.sha }}"
          MIGRATION_FILES=$(git diff --name-only $BASE_COMMIT..$HEAD_COMMIT | grep "supabase/migrations/.*\.sql$" || echo "")
          if [ -n "$MIGRATION_FILES" ]; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "migration_files<<EOF" >> $GITHUB_OUTPUT
            echo "$MIGRATION_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          fi

      - name: Note about migrations
        if: steps.detect-changes.outputs.has_migrations == 'true'
        id: handle-migrations
        run: |
          echo "Migration files found:"
          echo "${{ steps.detect-changes.outputs.migration_files }}"

      - name: Clean previous Vercel config
        run: rm -rf .vercel

      - name: Pull Vercel environment
        run: |
          vercel pull --yes \
            --environment preview \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --org-id ${{ secrets.VERCEL_ORG_ID }} \
            --project-id ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build project artifacts
        run: |
          vercel build \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --org-id ${{ secrets.VERCEL_ORG_ID }} \
            --project-id ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy preview to Vercel
        id: deploy
        run: |
          git config user.name "Mu√±oz Nahuel Alan"
          git config user.email "alan.n.m_21@hotmail.com"
          git commit --allow-empty -m "temp: deployment commit" --author="Mu√±oz Nahuel Alan <alan.n.m_21@hotmail.com>"
          DEPLOYMENT_URL=$(vercel deploy --prebuilt \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --org-id ${{ secrets.VERCEL_ORG_ID }} \
            --project-id ${{ secrets.VERCEL_PROJECT_ID }} \
            --confirm)
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          git reset --hard HEAD~1

      - name: Comment deployment URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('üöÄ Preview Deployment')
            );
            const hasMigrations = '${{ steps.detect-changes.outputs.has_migrations }}' === 'true';
            let statusIcon = hasMigrations ? '‚ö†Ô∏è' : '‚úÖ';
            let statusText = hasMigrations ? 'Deployed (with pending migrations)' : 'Deployed successfully';
            let migrationInfo = hasMigrations ?
              '**Database:** üóÑÔ∏è Using current staging database. Migrations will be applied on merge.' :
              '**Database:** ‚úÖ No migrations detected';
            const commentBody = `## ${statusIcon} Preview Deployment

**Status:** ${statusText}

**Preview URL:** [${{ steps.deploy.outputs.deployment_url }}](${{ steps.deploy.outputs.deployment_url }})

${migrationInfo}

The preview will be automatically updated when you push new commits to this PR.`;
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }
