name: Deploy to Vercel + Supabase

on:
  push:
    branches: [develop, main, feature/**]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GITHUB_ACTIONS: true
      CI: true
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Configure Git identity
        run: |
          git config user.name "Nico Segurado"
          git config user.email "nicosegurado735@gmail.com"

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ğŸ”§ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ğŸ”§ Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ” Verify environment variables
        run: |
          echo "ğŸ” Checking environment variables..."
          echo "NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-'NOT SET'}"
          echo "SUPABASE_DB_PASSWORD: ${SUPABASE_DB_PASSWORD:-'NOT SET'}"
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ] || [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "âŒ Required Supabase environment variables are not set"
            exit 1
          fi
          echo "âœ… Environment variables are properly set"

      - name: ğŸ” Determine deployment target
        id: deployment
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "target=production" >> $GITHUB_OUTPUT
          else
            echo "target=preview" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Create Vercel project config
        run: |
          mkdir -p .vercel
          cat << EOF > .vercel/project.json
          {
            "projectId": "${{ secrets.VERCEL_PROJECT_ID }}",
            "orgId": "${{ secrets.VERCEL_ORG_ID }}"
          }
          EOF

      - name: ğŸ” Check for new Supabase migrations
        id: migration-check
        run: |
          MIGRATION_FILES=$(find supabase/migrations -name "*.sql" -newer .github/workflows/deploy.yml 2>/dev/null || echo "")
          if [ -n "$MIGRATION_FILES" ]; then
            echo "has-migrations=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Migration files detected:"; echo "$MIGRATION_FILES"
          else
            echo "has-migrations=false" >> $GITHUB_OUTPUT
            echo "âœ… No new migration files found"
          fi

      - name: ğŸ” Validate migration order (optional)
        if: steps.migration-check.outputs.has-migrations == 'true'
        run: |
          echo "ğŸ” Validating migration timestamps..."
          bash scripts/validate-migration-order.sh || {
            echo "âš ï¸ Migration order validation failed, applying all migrations anyway"
          }
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        continue-on-error: true

      - name: ğŸš€ Deploy project to Vercel
        run: |
          vercel deploy \
            ${{ steps.deployment.outputs.target == 'production' && '--prod' || '' }} \
            --yes \
            --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ”„ Apply Supabase migrations (optional)
        if: steps.migration-check.outputs.has-migrations == 'true'
        run: |
          echo "ğŸ“‹ Applying Supabase migrations..."
          export SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL"
          export SUPABASE_DB_PASSWORD="$SUPABASE_DB_PASSWORD"
          supabase link --project-ref $(echo $NEXT_PUBLIC_SUPABASE_URL | sed 's/.*\/\/\([^.]*\).*/\1/')
          supabase db push --include-all
        continue-on-error: true

      - name: ğŸ”„ Revalidate Vercel cache after migrations (optional)
        if: steps.migration-check.outputs.has-migrations == 'true'
        run: |
          echo "ğŸ”„ Revalidating Vercel cache..."
          curl -X POST "https://api.vercel.com/v1/integrations/deploy/${{ secrets.VERCEL_PROJECT_ID }}/${{ secrets.VERCEL_TOKEN }}"
        continue-on-error: true

      - name: ğŸ”§ Clean up temporary commit (optional)
        run: git reset --hard HEAD~1
        continue-on-error: true
