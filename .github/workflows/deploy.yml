name: Deploy to Vercel

on:
  push:
    branches: [develop, main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Preview' }}
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      GITHUB_REF: ${{ github.ref }}
      GITHUB_ACTIONS: true
      CI: true

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîß Configure Git identity for Vercel
        run: |
          git config user.name "Mu√±oz Nahuel Alan"
          git config user.email "alan.n.m_21@hotmail.com"

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: üîß Install Vercel CLI
        run: npm install --global vercel@latest

      - name: üßπ Clean up old Vercel config
        run: rm -rf .vercel

      - name: üîß Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: üîÑ Sync migrations with remote database
        run: |
          echo "üîÑ Syncing local migrations with remote database..."
          # Link to the remote project using the ref from NEXT_PUBLIC_SUPABASE_URL
          export SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL"
          supabase link --project-ref $(echo $NEXT_PUBLIC_SUPABASE_URL | sed 's/.*\/\/\([^.]*\).*/\1/')
          # Pull remote schema/migrations to align local state
          supabase db pull
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: üîç Verify environment variables
        run: |
          echo "üîç Checking environment variables..."
          echo "NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-'NOT SET'}"
          echo "SUPABASE_DB_PASSWORD: ${SUPABASE_DB_PASSWORD:-'NOT SET'}"
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ] || [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "‚ùå Required Supabase environment variables are not set"
            exit 1
          fi
          echo "‚úÖ Environment variables are properly set"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: üîç Detect deployment type and migrations
        run: |
          echo "üîç Analyzing deployment..."
          echo "Branch: ${{ github.ref }}"
          echo "Target: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}"

          # Check for migration files
          MIGRATION_FILES=$(find supabase/migrations -name "*.sql" -newer .github/workflows/deploy.yml 2>/dev/null || echo "")
          if [ -n "$MIGRATION_FILES" ]; then
            echo "üìã Migration files detected:"
            echo "$MIGRATION_FILES"
          else
            echo "‚úÖ No new migration files found"
          fi

      - name: ‚¨áÔ∏è Pull Vercel environment information
        run: vercel pull --yes --environment=${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: üèóÔ∏è Build project artifacts
        run: vercel build ${{ github.ref == 'refs/heads/main' && '--prod' || '' }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: üîß Create temporary commit for Vercel authorization
        run: |
          git commit --allow-empty -m "temp: deployment commit" --author="Nico Segurado <nicosegurado735@gmail.com>"

      - name: üöÄ Deploy prebuilt project to Vercel
        run: vercel deploy --prebuilt ${{ github.ref == 'refs/heads/main' && '--prod' || '' }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: üîß Clean up temporary commit
        run: |
          git reset --hard HEAD~1

      - name: üîç Check for new migrations
        id: migration-check
        run: |
          MIGRATION_FILES=$(find supabase/migrations -name "*.sql" -newer .github/workflows/deploy.yml 2>/dev/null || echo "")
          if [ -n "$MIGRATION_FILES" ]; then
            echo "has-migrations=true" >> $GITHUB_OUTPUT
            echo "üìã Migration files detected:"
            echo "$MIGRATION_FILES"
          else
            echo "has-migrations=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No new migration files found"
          fi

      - name: üéØ Determine deployment target
        id: deployment-type
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "target=production" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "target=preview" >> $GITHUB_OUTPUT
            echo "environment=preview" >> $GITHUB_OUTPUT
          fi

      - name: üîç Validate migration order
        if: steps.migration-check.outputs.has-migrations == 'true'
        run: |
          echo "üîç Validating migration timestamps..."
          bash scripts/validate-migration-order.sh || {
            echo ""
            echo "‚ö†Ô∏è  Migration order validation failed, but continuing with --include-all flag"
            echo "   This will apply all migrations regardless of timestamp order"
            echo ""
          }
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        continue-on-error: true

      - name: üóÑÔ∏è Run database migrations
        if: steps.migration-check.outputs.has-migrations == 'true'
        run: |
          echo "üöÄ Running database migrations..."
          echo "Target: ${{ steps.deployment-type.outputs.target }}"

          # Set Supabase environment variables
          export SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL"
          export SUPABASE_DB_PASSWORD="$SUPABASE_DB_PASSWORD"

          # Link to the remote project
          supabase link --project-ref $(echo $NEXT_PUBLIC_SUPABASE_URL | sed 's/.*\/\/\([^.]*\).*/\1/')

          # Run migrations with --include-all to handle out-of-order migrations
          echo "üìã Applying migrations (including out-of-order)..."
          supabase db push --include-all
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: üìä Run analytics reports seed
        if: steps.migration-check.outputs.has-migrations == 'true' && github.ref == 'refs/heads/main'
        continue-on-error: true
        run: |
          echo "üìä Running analytics reports seed..."

          # Install dependencies if needed
          pnpm install --frozen-lockfile || {
            echo "‚ö†Ô∏è Failed to install dependencies, skipping seed"
            exit 0
          }

          # Run the reports seed
          node --import tsx scripts/seed-recaudacion-reportes.ts || {
            echo "‚ö†Ô∏è Reports seed failed, but continuing deployment"
            exit 0
          }

          echo "‚úÖ Reports seed completed successfully"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CI: true

      - name: üîÑ Revalidate Vercel cache
        if: steps.migration-check.outputs.has-migrations == 'true'
        run: |
          echo "üîÑ Revalidating Vercel cache after migrations..."
          curl -X POST "https://api.vercel.com/v1/integrations/deploy/${{ secrets.VERCEL_PROJECT_ID }}/${{ secrets.VERCEL_TOKEN }}"
